<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiveTemplate JavaScript Client - Browser Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            color: #6c757d;
            font-size: 14px;
        }
        .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .demo-container {
            border: 2px dashed #dee2e6;
            padding: 20px;
            margin: 15px 0;
            border-radius: 6px;
            background: #f8f9fa;
        }
        #liveDemo {
            min-height: 100px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ LiveTemplate JavaScript Client - Browser Tests</h1>
        <p>Tree-based optimization with 92%+ bandwidth savings</p>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <button onclick="runLiveDemo()">üé≠ Start Live Demo</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
        <button onclick="exportResults()">üíæ Export Results</button>
    </div>

    <div class="test-section">
        <h2>Test Progress</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>
        <p id="progressText">Ready to run tests...</p>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="totalTests">0</div>
                <div class="metric-label">Total Tests</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="passedTests">0</div>
                <div class="metric-label">Passed</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="failedTests">0</div>
                <div class="metric-label">Failed</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="successRate">0%</div>
                <div class="metric-label">Success Rate</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="avgSavings">0%</div>
                <div class="metric-label">Avg Bandwidth Savings</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="avgProcessing">0ms</div>
                <div class="metric-label">Avg Processing Time</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Live Demo</h2>
        <p>Interactive demonstration of tree-based fragment updates with real-time bandwidth calculations.</p>
        <div class="demo-container">
            <div id="liveDemo">Click "Start Live Demo" to see tree-based optimization in action!</div>
            <div id="demoStats" class="code"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>Detailed Test Results</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Client Information</h2>
        <div id="clientInfo" class="code"></div>
    </div>

    <!-- Load the TreeFragmentClient -->
    <script src="../../../pkg/client/web/tree-fragment-client.js"></script>
    
    <script>
        // Global test state
        let testResults = [];
        let client = null;
        let demoInterval = null;

        // Initialize client
        function initializeClient() {
            client = new TreeFragmentClient({
                enableLogging: true,
                enableMetrics: true,
                maxCacheSize: 100
            });
            
            // Display client info
            const clientInfo = client.getClientInfo();
            document.getElementById('clientInfo').textContent = JSON.stringify(clientInfo, null, 2);
        }

        // Test data - same as Node.js tests for consistency
        function getTestData() {
            return {
                simpleField: {
                    template: '<p>Hello {{.Name}}!</p>',
                    description: 'Single field text replacement',
                    firstResult: {"0":"World","s":["<p>Hello ","!</p>"]},
                    updateResult: {"0":"Universe"},
                    expectedHtml: "<p>Hello World!</p>",
                    expectedUpdateHtml: "<p>Hello Universe!</p>"
                },
                multipleFields: {
                    template: '<div>{{.Name}} has {{.Score}} points</div>',
                    description: 'Multiple field updates in single template',
                    firstResult: {"0":"Alice","1":"100","s":["<div>"," has "," points</div>"]},
                    updateResult: {"0":"Bob","1":"250"},
                    expectedHtml: "<div>Alice has 100 points</div>",
                    expectedUpdateHtml: "<div>Bob has 250 points</div>"
                },
                conditionalTrue: {
                    template: '<div>{{if .Show}}Welcome {{.Name}}!{{else}}Please log in{{end}}</div>',
                    description: 'Conditional branch with nested dynamics',
                    firstResult: {"0":{"0":"John","s":["Welcome ","!"]},"s":["<div>","</div>"]},
                    updateResult: {"0":{"0":"Jane"}},
                    expectedHtml: "<div>Welcome John!</div>",
                    expectedUpdateHtml: "<div>Welcome Jane!</div>"
                },
                rangeItems: {
                    template: '<ul>{{range .Items}}<li>{{.}}</li>{{end}}</ul>',
                    description: 'Range loop with item addition',
                    firstResult: {"0":[{"0":"Apple","s":["<li>","</li>"]},{"0":"Banana","s":["<li>","</li>"]}],"s":["<ul>","</ul>"]},
                    updateResult: {"0":[{"0":"Apple","s":["<li>","</li>"]},{"0":"Banana","s":["<li>","</li>"]},{"0":"Cherry","s":["<li>","</li>"]}]},
                    expectedHtml: "<ul><li>Apple</li><li>Banana</li></ul>",
                    expectedUpdateHtml: "<ul><li>Apple</li><li>Banana</li><li>Cherry</li></ul>"
                }
            };
        }

        // Run individual test
        function runTest(testName, testCase) {
            const startTime = Date.now();
            
            try {
                console.log(`Running test: ${testName}`);
                
                // Initial render
                const initialFragment = { id: testName, data: testCase.firstResult };
                const initialHtml = client.processFragment(initialFragment, true);
                const initialMatch = initialHtml === testCase.expectedHtml;
                
                // Update render
                const updateFragment = { id: testName, data: testCase.updateResult };
                const updateHtml = client.processFragment(updateFragment, false);
                const updateMatch = updateHtml === testCase.expectedUpdateHtml;
                
                // Bandwidth savings
                const savings = client.calculateSavings(testCase.firstResult, testCase.updateResult);
                
                // Cache validation
                const cacheStats = client.getCacheStats();
                const hasCachedStructure = cacheStats.fragmentIds.includes(testName);
                
                const processingTime = Date.now() - startTime;
                const passed = initialMatch && updateMatch;
                
                const result = {
                    name: testName,
                    description: testCase.description,
                    template: testCase.template,
                    initialMatch,
                    updateMatch,
                    savings,
                    hasCachedStructure,
                    processingTime,
                    passed,
                    timestamp: new Date().toISOString(),
                    initialHtml,
                    updateHtml,
                    expectedInitial: testCase.expectedHtml,
                    expectedUpdate: testCase.expectedUpdateHtml
                };
                
                testResults.push(result);
                return result;
                
            } catch (error) {
                const errorResult = {
                    name: testName,
                    description: testCase.description,
                    error: error.message,
                    passed: false,
                    timestamp: new Date().toISOString()
                };
                testResults.push(errorResult);
                return errorResult;
            }
        }

        // Run all tests
        async function runAllTests() {
            if (!client) initializeClient();
            
            testResults = [];
            const testData = getTestData();
            const tests = Object.keys(testData);
            let completedTests = 0;
            
            updateProgress(0, tests.length, 'Starting tests...');
            
            for (const testName of tests) {
                const result = runTest(testName, testData[testName]);
                completedTests++;
                
                updateProgress(completedTests, tests.length, `Completed ${testName}`);
                displayTestResult(result);
                
                // Small delay for visual effect
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Run edge case tests
            await runEdgeCaseTests();
            
            updateSummary();
            updateProgress(tests.length, tests.length, 'All tests completed!');
        }

        // Edge case tests
        async function runEdgeCaseTests() {
            const edgeCases = [
                {
                    name: 'Empty Fragment',
                    test: () => client.processFragment({ id: 'empty', data: {} }, true) === ''
                },
                {
                    name: 'Null Data',
                    test: () => client.processFragment({ id: 'null', data: null }, true) === ''
                },
                {
                    name: 'Cache Clearing',
                    test: () => {
                        client.processFragment({ id: 'clear-test', data: { "s": ["test"] } }, true);
                        return client.clearCache('clear-test');
                    }
                }
            ];
            
            for (const edgeCase of edgeCases) {
                try {
                    const passed = edgeCase.test();
                    const result = {
                        name: edgeCase.name,
                        description: 'Edge case test',
                        passed,
                        processingTime: 0,
                        timestamp: new Date().toISOString()
                    };
                    testResults.push(result);
                    displayTestResult(result);
                } catch (error) {
                    const errorResult = {
                        name: edgeCase.name,
                        description: 'Edge case test',
                        error: error.message,
                        passed: false,
                        timestamp: new Date().toISOString()
                    };
                    testResults.push(errorResult);
                    displayTestResult(errorResult);
                }
            }
        }

        // Update progress bar
        function updateProgress(completed, total, message) {
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = message;
        }

        // Display individual test result
        function displayTestResult(result) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
            
            let html = `
                <h4>${result.passed ? '‚úÖ' : '‚ùå'} ${result.name}</h4>
                <p><strong>Description:</strong> ${result.description}</p>
            `;
            
            if (result.template) {
                html += `<p><strong>Template:</strong> <code>${result.template}</code></p>`;
            }
            
            if (result.error) {
                html += `<p><strong>Error:</strong> ${result.error}</p>`;
            } else {
                html += `
                    <p><strong>Processing Time:</strong> ${result.processingTime}ms</p>
                    <p><strong>Cache Working:</strong> ${result.hasCachedStructure ? 'Yes' : 'No'}</p>
                `;
                
                if (result.savings) {
                    html += `<p><strong>Bandwidth Savings:</strong> ${result.savings.savingsFormatted}</p>`;
                }
                
                if (result.initialHtml) {
                    html += `
                        <details>
                            <summary>HTML Comparison</summary>
                            <div class="code">
Expected Initial: ${result.expectedInitial}
Actual Initial:   ${result.initialHtml}
Expected Update:  ${result.expectedUpdate}
Actual Update:    ${result.updateHtml}
                            </div>
                        </details>
                    `;
                }
            }
            
            resultDiv.innerHTML = html;
            resultsDiv.appendChild(resultDiv);
        }

        // Update summary metrics
        function updateSummary() {
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.passed).length;
            const failedTests = totalTests - passedTests;
            const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
            
            // Calculate average savings
            const validResults = testResults.filter(r => r.savings && !isNaN(r.savings.savings));
            const avgSavings = validResults.length > 0 
                ? (validResults.reduce((sum, r) => sum + r.savings.savings, 0) / validResults.length).toFixed(1)
                : 0;
            
            // Calculate average processing time
            const processingResults = testResults.filter(r => r.processingTime !== undefined);
            const avgProcessing = processingResults.length > 0
                ? (processingResults.reduce((sum, r) => sum + r.processingTime, 0) / processingResults.length).toFixed(1)
                : 0;
            
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('avgSavings').textContent = avgSavings + '%';
            document.getElementById('avgProcessing').textContent = avgProcessing + 'ms';
        }

        // Live demo
        function runLiveDemo() {
            if (!client) initializeClient();
            
            clearInterval(demoInterval);
            
            const templates = [
                {
                    name: 'User Dashboard',
                    initial: {"0":"John","1":"42","s":["<div class='user'>Welcome "," (Level ",")!</div>"]},
                    updates: [
                        {"0":"Jane","1":"45"},
                        {"0":"Alice","1":"38"},
                        {"0":"Bob","1":"52"}
                    ]
                },
                {
                    name: 'Live Counter',
                    initial: {"0":"1","s":["<span class='counter'>Count: ","</span>"]},
                    updates: Array.from({length: 10}, (_, i) => ({"0": String(i + 2)}))
                }
            ];
            
            let templateIndex = 0;
            let updateIndex = 0;
            let totalSavings = 0;
            let updates = 0;
            
            // Initial render
            let currentTemplate = templates[templateIndex];
            let html = client.processFragment({ 
                id: 'live-demo', 
                data: currentTemplate.initial 
            }, true);
            
            document.getElementById('liveDemo').innerHTML = html;
            
            demoInterval = setInterval(() => {
                const template = templates[templateIndex];
                
                if (updateIndex < template.updates.length) {
                    const updateData = template.updates[updateIndex];
                    html = client.processFragment({ 
                        id: 'live-demo', 
                        data: updateData 
                    }, false);
                    
                    document.getElementById('liveDemo').innerHTML = html;
                    
                    // Calculate savings
                    const savings = client.calculateSavings(template.initial, updateData);
                    totalSavings += Math.max(0, savings.savings);
                    updates++;
                    
                    // Update stats
                    document.getElementById('demoStats').textContent = 
                        `Template: ${template.name}\n` +
                        `Updates: ${updates}\n` +
                        `Current Savings: ${savings.savingsFormatted}\n` +
                        `Average Savings: ${(totalSavings / updates).toFixed(1)}%\n` +
                        `Cache Size: ${client.getCacheStats().cachedStructures}`;
                    
                    updateIndex++;
                } else {
                    // Move to next template
                    templateIndex = (templateIndex + 1) % templates.length;
                    updateIndex = 0;
                    
                    currentTemplate = templates[templateIndex];
                    html = client.processFragment({ 
                        id: 'live-demo', 
                        data: currentTemplate.initial 
                    }, true);
                    
                    document.getElementById('liveDemo').innerHTML = html;
                }
            }, 1000);
        }

        // Clear all results
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = 'Ready to run tests...';
            updateSummary();
            clearInterval(demoInterval);
            document.getElementById('liveDemo').innerHTML = 'Click "Start Live Demo" to see tree-based optimization in action!';
            document.getElementById('demoStats').textContent = '';
        }

        // Export results
        function exportResults() {
            if (testResults.length === 0) {
                alert('No test results to export. Run tests first!');
                return;
            }
            
            const report = {
                summary: {
                    timestamp: new Date().toISOString(),
                    totalTests: testResults.length,
                    passedTests: testResults.filter(r => r.passed).length,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                },
                clientInfo: client ? client.getClientInfo() : null,
                metrics: client ? client.getMetrics() : null,
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `livetemplate-browser-test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            initializeClient();
            console.log('LiveTemplate Browser Test Suite initialized');
        });
    </script>
</body>
</html>